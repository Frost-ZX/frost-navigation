import{_ as q,m as Z,A as j,g as z,C as J,D as Q,x as c,n as m,q as a,w as r,p as s,b0 as k,aK as o,aZ as y,o as n,aN as g,t as v,a$ as W,F as Y,y as ee,aX as te,b5 as D,$ as L,aG as le}from"./index-BKvL4bCX.js";import{g as H}from"./getCommonDateTime-9O9gLM5u.js";import{b as ie}from"./index-JVWQwFoa.js";import{d as se,g as F}from"./Select-y25Hn_WI.js";import{N as R}from"./Flex-C-gYDqtT.js";import{N as ae}from"./InputNumber-BVO98d2U.js";import"./Popover-BG5MQIM7.js";import"./get-CQG32wRx.js";import"./Follower-L5kM5qp8.js";import"./use-merged-state-CKbFJlkG.js";import"./Input-CylcvuRs.js";import"./get-slot-Bk_rJcZu.js";const re={class:"tool-detail-page"},oe={class:"config-item"},ne={class:"config-item__content"},de={class:"config-item"},ue={class:"config-item__content"},fe={key:0,class:"mdi mdi-arrow-collapse"},pe={key:1,class:"mdi mdi-arrow-expand"},ce={class:"chat-history__text"},me={__name:"ChatHistoryReader",setup(ye){const b={LOG_CHAT_MSG_1:/\[CHAT\]\s+(.*)$/,LOG_TIME:/\[(\d{2}:\d{2}:\d{2})\]/},{data:B,fileLastModified:w,fileName:I,fileSize:h,isSupported:O,open:A,updateData:E}=ie({dataType:"ArrayBuffer",excludeAcceptAllOption:!0,types:[{accept:{"text/plain":[".log"]},description:"Minecraft 日志文件"}]}),N=Z(null),t=j({isFullView:!1,isReadingFile:!1,isOpenedFile:!1,lastFileSize:0,LastModifiedTime:0,lastReadLineNumber:0,readInterval:2,readTimer:null,textEncoding:"utf-8",textRows:[]}),$=z(()=>{let l=h.value;return l?"".concat((l/1024).toFixed(2)," KB"):"-"}),G=z(()=>{let l=w.value;return l?H(l,"all"):"-"});function V(){let l=N.value;if(!l){console.error("自动滚动失败：元素不存在");return}let e=l.getBoundingClientRect(),i=Math.round(e.height),u=l.scrollHeight,d=0,f=l.scrollTop;u-f===i&&le(()=>{d=l.scrollHeight,d>i&&l.scrollTo({behavior:"instant",top:d-i})})}function U(){t.textRows=[]}function K(l=null){try{return new TextDecoder(t.textEncoding).decode(l)}catch(e){return console.error("解码失败："),console.error(e),""}}function S(l=!1){t.lastFileSize=0,t.LastModifiedTime=0,t.lastReadLineNumber=0,t.textRows=l?[{id:D(),type:"chat",time:H(null,"time"),text:"请点击按钮选择日志文件以开始。"}]:[]}async function T(l=!1){l&&await E();let e=h.value,i=w.value,u=B.value,d="",f=t.lastReadLineNumber,x=[],C=[];if(i===t.LastModifiedTime)return!1;if(t.LastModifiedTime=i,u instanceof ArrayBuffer&&(d=K(u)),d)x=d.split("\n").map(p=>p.replace(/\r$/,"")).filter(p=>!!p);else return console.warn("文件内容为空或解码失败"),!1;return e<t.lastFileSize&&(f=0),x.splice(0,f),f+=x.length,x.forEach(p=>{let M=P(p);M.type==="chat"&&C.push(M)}),t.lastFileSize=e,t.lastReadLineNumber=f,t.textRows.push.apply(t.textRows,C),V(),!0}function P(l=""){try{let e=l.match(b.LOG_CHAT_MSG_1),i=e?e[1]:"",u=l.match(b.LOG_TIME),d=u?u[1]:"";if(i)return i=i.replace(/\\n/g,"\n").replace(/§\w/g,""),{id:D(),type:"chat",time:d,text:i}}catch(e){console.error("解析内容失败："),console.error(e)}return{id:null,type:"",time:"",text:""}}async function X(){if(!O.value)return L.error("当前浏览器不支持该功能"),!1;try{return await A(),L.success("打开文件成功"),t.isOpenedFile=!0,S(!1),T(!1),_(!0),!0}catch(l){return console.error("打开文件失败："),console.error(l),L.error("打开文件失败"),!1}}function _(l=!1){if(t.readTimer&&clearInterval(t.readTimer),!l){t.isReadingFile=!1,t.readTimer=null;return}t.isReadingFile=!0,t.readTimer=setInterval(()=>{T(!0)},t.readInterval*1e3)}return J(()=>{S(!0)}),Q(()=>{_(!1)}),(l,e)=>(c(),m("div",re,[a(s(y),{size:"small",title:"说明"},{default:r(()=>[a(s(k),null,{default:r(()=>e[7]||(e[7]=[o("已测试游戏版本：1.12.2 ~ 1.21.4")])),_:1}),a(s(k),null,{default:r(()=>e[8]||(e[8]=[o("若内容出现乱码，请尝试更改“文件编码”后重新打开文件。")])),_:1})]),_:1}),a(s(y),{size:"small",title:"设置"},{default:r(()=>[a(s(R),null,{default:r(()=>[n("div",oe,[e[9]||(e[9]=n("div",{class:"config-item__label"},"文件编码：",-1)),n("div",ne,[a(s(se),{value:t.textEncoding,"onUpdate:value":e[0]||(e[0]=i=>t.textEncoding=i),options:[{label:"GBK",value:"gbk"},{label:"UTF-8",value:"utf-8"}]},null,8,["value"])])]),n("div",de,[e[11]||(e[11]=n("div",{class:"config-item__label"},"读取间隔：",-1)),n("div",ue,[a(s(ae),{value:t.readInterval,"onUpdate:value":e[1]||(e[1]=i=>t.readInterval=i),disabled:t.isReadingFile,min:1,max:60,precision:0,step:1},null,8,["value","disabled"]),e[10]||(e[10]=n("span",{style:{"margin-left":"0.5em"}},"秒",-1))])])]),_:1})]),_:1}),a(s(y),{size:"small",title:"操作"},{default:r(()=>[a(s(R),{class:"action-row"},{default:r(()=>[a(s(g),{type:"success",onClick:X},{default:r(()=>e[12]||(e[12]=[o("选择文件")])),_:1}),a(s(g),{type:"primary",disabled:!t.isOpenedFile,onClick:e[2]||(e[2]=i=>T(!0))},{default:r(()=>e[13]||(e[13]=[o("刷新内容")])),_:1},8,["disabled"]),a(s(g),{type:"primary",disabled:!t.isOpenedFile||t.isReadingFile,onClick:e[3]||(e[3]=i=>_(!0))},{default:r(()=>e[14]||(e[14]=[o("开始读取")])),_:1},8,["disabled"]),a(s(g),{type:"error",disabled:!t.isOpenedFile||!t.isReadingFile,onClick:e[4]||(e[4]=i=>_(!1))},{default:r(()=>e[15]||(e[15]=[o("停止读取")])),_:1},8,["disabled"]),a(s(g),{type:"error",onClick:U},{default:r(()=>e[16]||(e[16]=[o("清空内容")])),_:1})]),_:1})]),_:1}),a(s(y),{size:"small",title:"信息"},{default:r(()=>[a(s(R),null,{default:r(()=>[a(s(F),{type:"info"},{default:r(()=>[o("文件名称："+v(s(I)||"-"),1)]),_:1}),a(s(F),{type:"info"},{default:r(()=>[o("文件大小："+v($.value),1)]),_:1}),a(s(F),{type:"info"},{default:r(()=>[o("修改时间："+v(G.value),1)]),_:1})]),_:1})]),_:1}),a(s(y),{size:"small",title:"内容",class:te({"chat-history":!0,"chat-history--is-full":t.isFullView})},{"header-extra":r(()=>[n("div",{class:"chat-history__toggle-full",onClick:e[5]||(e[5]=i=>t.isFullView=!t.isFullView)},[t.isFullView?(c(),m("span",fe)):(c(),m("span",pe))])]),default:r(()=>[n("div",{class:"chat-history__wrapper",onContextmenu:e[6]||(e[6]=W(()=>{},["stop"]))},[n("div",{ref_key:"chatHistoryListRef",ref:N,class:"chat-history__list"},[(c(!0),m(Y,null,ee(t.textRows,i=>(c(),m("div",{key:i.id,class:"chat-history__item"},[a(s(F),{class:"chat-history__time",size:"small",type:"info"},{default:r(()=>[o(v(i.time),1)]),_:2},1024),n("div",ce,v(i.text),1)]))),128))],512)],32)]),_:1},8,["class"])]))}},Se=q(me,[["__scopeId","data-v-8fa9d147"]]);export{Se as default};
